---
import Layout from '../../layouts/Layout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const entries = await getCollection('journal', ({ data }) => data.draft !== true);
  return entries.map((entry) => ({
    params: { slug: entry.data.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, headings } = await render(entry);
const siteUrl = import.meta.env.SITE_URL || Astro.url.origin;
const canonicalUrl = new URL(`/journal/${entry.data.slug}`, siteUrl).href;
const ogImage = entry.data.ogImage ?? entry.data.coverImage;

const allPublished = await getCollection('journal', ({ data }) => data.draft !== true);
const sameCategory = allPublished.filter((e) => e.data.category === entry.data.category && e.data.slug !== entry.data.slug);
const entryTags = new Set(entry.data.tags ?? []);
const withTagOverlap = sameCategory
  .map((e) => ({ entry: e, score: (e.data.tags ?? []).filter((t) => entryTags.has(t)).length }))
  .sort((a, b) => b.score - a.score);
const related = withTagOverlap.slice(0, 3).map(({ entry: e }) => e);

const categoryLabels: Record<string, string> = { women: '여성', kids: '아이', parents: '부모' };
---

<Layout
  title={entry.data.title}
  description={entry.data.description}
  canonical={canonicalUrl}
  ogImage={ogImage}
>
  <article class="article">
    <header>
      <span class="meta">{categoryLabels[entry.data.category]} · {entry.data.date.toLocaleDateString('ko-KR')}</span>
      <h1>{entry.data.title}</h1>
    </header>
    <div class="prose">
      <Content />
    </div>
    {related.length > 0 && (
      <aside class="related">
        <h2>관련 글</h2>
        <ul>
          {related.map((r) => (
            <li><a href={`/journal/${r.data.slug}`}>{r.data.title}</a></li>
          ))}
        </ul>
      </aside>
    )}
    <p class="cta-wrap"><a href="/journal" class="cta">목록으로</a> · <a href="/about">소개 보기</a></p>
  </article>
</Layout>

<script type="application/ld+json" set:html={JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: entry.data.title,
  description: entry.data.description,
  datePublished: entry.data.date.toISOString(),
  author: { '@type': 'Organization', name: '숨이' },
  url: canonicalUrl,
})} />

<style>
  .article header {
    margin-bottom: 1.5rem;
  }
  .meta {
    font-size: 0.875rem;
    color: var(--color-muted);
    display: block;
    margin-bottom: 0.5rem;
  }
  .article h1 {
    font-size: 1.5rem;
    margin: 0;
  }
  .prose :global(h2) {
    font-size: 1.15rem;
    margin: 1.5rem 0 0.5rem;
  }
  .prose :global(p) {
    margin: 0.75rem 0;
  }
  .related {
    margin-top: 2.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
  }
  .related h2 {
    font-size: 1rem;
    margin: 0 0 0.75rem;
  }
  .related ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .related a {
    color: var(--color-text);
    text-decoration: none;
  }
  .related a:hover {
    text-decoration: underline;
  }
  .cta-wrap {
    margin-top: 2rem;
    font-size: 0.9rem;
  }
  .cta-wrap a {
    color: var(--color-text);
    text-decoration: underline;
  }
  .cta {
    font-weight: 500;
  }
</style>
